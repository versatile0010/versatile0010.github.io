---
title: " ğŸ‘€ Stream.collect(Collectors.toList()) vs. Stream.toList() "

categories: 
  - Java  
layout: single
classes: wide
last_modified_at: now
---

> Stream.collect(Collectors.toList()) returns a mutable list, while Stream.toList() (introduced in JDK 16) returns an immutable list.
Using Stream.toList() without considering its immutability can lead to UnsupportedOperationException.

###  Stream.collect(Collectors.toList()) ì™€ Stream.toList() ëŠ” ë‹¤ë¥´ë‹¤!

![image](https://github.com/versatile0010/versatile0010.github.io/assets/96612168/1953cf83-bc6d-490f-b678-6d0157bf57b4)


---

ì–´ëŠë‚  production ì˜ ë ˆê±°ì‹œ ë¡œì§ì—ì„œ ë°œìƒí•œ UnsupportedOperationException...

ë¬´ì—‡ì´ ë¬¸ì œì˜€ì„ê¹Œìš”?

---

java ë¡œ ë°±ì—”ë“œ ê°œë°œì„ í•˜ë‹¤ ë³´ë©´, 

ê°€ì¥ í”í•œ íŒ¨í„´ ì¤‘ í•˜ë‚˜ê°€ 

íŠ¹ì • ë°ì´í„°ë¥¼ ì›í•˜ëŠ” í˜•íƒœë¡œ ë³€í™˜í•˜ê±°ë‚˜ ì¶”ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì´ë•ŒëŠ” Stream API ë¥¼ ì‚¬ìš©í•˜ë©´ í¸ë¦¬í•˜ê³ , ì¼ë°˜ì ìœ¼ë¡œ ì¢‹ì€ ê°€ë…ì„±ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì•„ë˜ ì½”ë“œë¥¼ ì‚´í´ë´…ì‹œë‹¤.

```java
        List<String> imageUrls = articleImageRepository.findByArticle(article)
                .stream()
                .map(ArticleImage::getImageUrl)
                .collect(Collectors.toList());
```

ìœ„ ì½”ë“œ ìŠ¤ë‹ˆí«ì—ì„œëŠ” articleImage ì—”í‹°í‹° ë¦¬ìŠ¤íŠ¸ë¥¼ ì¿¼ë¦¬í•´ì˜¨ ë’¤ì—, ImageUrl ë§Œ List<String> ìœ¼ë¡œ ì¶”ì¶œí•˜ê³  ìˆìŠµë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì£¼ëª©í•´ì•¼ í•  ë¶€ë¶„ì€ `collect(Collectors.toList()` ì…ë‹ˆë‹¤.

í•´ë‹¹ ë¶€ë¶„ì— ì»¤ì„œë¥¼ ê°€ì ¸ë‹¤ ëŒ€ë©´ intelliJ ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì€ ë©”ì„¸ì§€ë¥¼ ë„ì›Œì¤ë‹ˆë‹¤.

```shell
`collect(toList())` can be replaced with 'toList()'

- Replace 'collect(toList())' with 'toList()'?
```

ì´ ì œì•ˆì„ ë¬´ì‹¬ì½” ìˆ˜ë½í•˜ë‹¤ê°€ëŠ”, ì˜ˆìƒì¹˜ ëª»í•œ ì ì¬ì ì¸ ë²„ê·¸ë¥¼ ì„œë¹„ìŠ¤ì— ì‹¬ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
 ğŸ”¥ Stream.collect(Collectors.toList()) ì™€ Stream.toList() ëŠ” ëª…ë°±í•˜ê²Œ ë‹¤ë¥´ë‹¤! 
```

---

### ì–´ë–»ê²Œ ë‹¤ë¥¼ê¹Œ?

ì£¼ìš”í•œ ì°¨ì´ì ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```java

- Stream.collect(Collectors.toList()) ëŠ” ê°€ë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.

- Stream.toList() ëŠ” ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•œë‹¤.

```

jdk 16 ë¶€í„° ë„ì…ëœ ë©”ì„œë“œ ì¸ `Stream.toList()` ëŠ” ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ë©°, ì™¸ë¶€ì—ì„œ ìˆ˜ì • ì‹œë„ ì‹œ `UnsupportedOperationException` ì´ í„°ì§‘ë‹ˆë‹¤. 

```java

List<String> mutableList = Stream.of("a", "b").collect(Collectors.toList());
mutableList.add("c"); // âœ… ê°€ëŠ¥

List<String> immutableList = Stream.of("a", "b").toList();
immutableList.add("c"); // ğŸ”¥ UnsupportedOperationException ë°œìƒ

```

í•„ìš”í•œ êµ¬í˜„ì²´ê°€ ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ì¸ì§€, ê°€ë³€ë¦¬ìŠ¤íŠ¸ì¸ì§€ ìš”êµ¬ì‚¬í•­ì„ ì •í™•í•˜ê²Œ íŒŒì•…í•˜ê³  ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.

IntelliJ, SonarQube ë“±ì—ì„œ `collect(Collectors.toList())` ë¥¼ `Stream.toList()` ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê²ƒì„ ê¶Œí•  ìˆ˜ ìˆì§€ë§Œ,

ë‘ ë©”ì„œë“œì˜ ê¸°ëŠ¥ì ì¸ ì°¨ì´ì ì„ ëª…í™•íˆ ì¸ì§€í•˜ì§€ ëª»í•œ ì±„ ë°›ì•„ë“¤ì´ë©´

ìƒí™©ì— ë”°ë¼ ê½¤ë‚˜ ì‹¬ê°í•œ ë²„ê·¸ê°€ ë°œìƒí•  ìˆ˜ë„ ìˆê² ì£ .

ëŒë‹¤ë¦¬ë„ ë‘ë“¤ê²¨ ë³´ê³  ê±´ë„ˆì•¼ í•  ê²ƒ ê°™ìŠµë‹ˆë‹¤.

---

### ë‚´ë¶€ êµ¬í˜„ ì½”ë“œë¥¼ ë”°ë¼ê°€ì„œ ë‘ ëˆˆìœ¼ë¡œ ê²€ì¦í•˜ê¸°

ì‹œê°„ì ìœ¼ë¡œ í—ˆìš©ëœë‹¤ë©´ ë°˜ë“œì‹œ ë‚´ë¶€ êµ¬í˜„ ì½”ë“œë¥¼ í™•ì¸í•´ì„œ, ìŠ¤ìŠ¤ë¡œ ë‚©ë“í•˜ëŠ” ê²ƒì´ ê°€ì¥ ê¸°ì–µì— ì˜¤ë˜ ë‚¨ëŠ” ê²ƒ ê°™ìŠµë‹ˆë‹¤.

jdk 17 ê¸°ì¤€ìœ¼ë¡œ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € `Stream.collect(Collectors.toList())` ë¶€í„° ë”°ë¼ê°€ë´…ì‹œë‹¤.

```java

    /**
     * Accumulates the elements of this stream into a {@code List}. The elements in
     * the list will be in this stream's encounter order, if one exists. The returned List
     * is unmodifiable; calls to any mutator method will always cause
     * {@code UnsupportedOperationException} to be thrown. There are no
     * guarantees on the implementation type or serializability of the returned List.
     *
     * <p>The returned instance may be <a href="{@docRoot}/java.base/java/lang/doc-files/ValueBased.html">value-based</a>.
     * Callers should make no assumptions about the identity of the returned instances.
     * Identity-sensitive operations on these instances (reference equality ({@code ==}),
     * identity hash code, and synchronization) are unreliable and should be avoided.
     *
     * <p>This is a <a href="package-summary.html#StreamOps">terminal operation</a>.
     *
     * @apiNote If more control over the returned object is required, use
     * {@link Collectors#toCollection(Supplier)}.
     *
     * @implSpec The implementation in this interface returns a List produced as if by the following:
     * <pre>{@code
     * Collections.unmodifiableList(new ArrayList<>(Arrays.asList(this.toArray())))
     * }</pre>
     *
     * @implNote Most instances of Stream will override this method and provide an implementation
     * that is highly optimized compared to the implementation in this interface.
     *
     * @return a List containing the stream elements
     *
     * @since 16
     */
    @SuppressWarnings("unchecked")
    default List<T> toList() {
        return (List<T>) Collections.unmodifiableList(new ArrayList<>(Arrays.asList(this.toArray())));
    }


    /**
     * Returns an <a href="Collection.html#unmodview">unmodifiable view</a> of the
     * specified list. Query operations on the returned list "read through" to the
     * specified list, and attempts to modify the returned list, whether
     * direct or via its iterator, result in an
     * {@code UnsupportedOperationException}.<p>
     *
     * The returned list will be serializable if the specified list
     * is serializable. Similarly, the returned list will implement
     * {@link RandomAccess} if the specified list does.
     *
     * @implNote This method may return its argument if the argument is already unmodifiable.
     * @param  <T> the class of the objects in the list
     * @param  list the list for which an unmodifiable view is to be returned.
     * @return an unmodifiable view of the specified list.
     */
    @SuppressWarnings("unchecked")
    public static <T> List<T> unmodifiableList(List<? extends T> list) {
      if (list.getClass() == UnmodifiableList.class || list.getClass() == UnmodifiableRandomAccessList.class) {
        return (List<T>) list;
      }

      return (list instanceof RandomAccess ?
        new UnmodifiableRandomAccessList<>(list) :
        new UnmodifiableList<>(list));
    }
```

ì´ë²ˆì—ëŠ” `collect(Collectors.toList())` ë¥¼ ë´…ì‹œë‹¤.

```java

    /**
     * Returns a {@code Collector} that accumulates the input elements into a
     * new {@code List}. There are no guarantees on the type, mutability,
     * serializability, or thread-safety of the {@code List} returned; if more
     * control over the returned {@code List} is required, use {@link #toCollection(Supplier)}.
     *
     * @param <T> the type of the input elements
     * @return a {@code Collector} which collects all the input elements into a
     * {@code List}, in encounter order
     */
    public static <T>
    Collector<T, ?, List<T>> toList() {
        return new CollectorImpl<>(ArrayList::new, List::add,
                                   (left, right) -> { left.addAll(right); return left; },
                                   CH_ID);
    }


```

ë¬´ì—‡ì´ ë‹¤ë¥¸ê°€ìš”?



`toList()` ì—ì„œ ë°˜í™˜í•˜ëŠ” êµ¬í˜„ì²´ëŠ” `Collectors.UnmodifiableRandomAccessList`, `Collectors.UnmodifiableList` ìœ¼ë¡œ ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ì´ì§€ë§Œ

`collect(Collectors.toList())` ì—ì„œ ë°˜í™˜í•˜ëŠ” êµ¬í˜„ì²´ëŠ” `ArrayList` ìœ¼ë¡œ ê°€ë³€ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.

---

ë¶ˆë³€ ë¦¬ìŠ¤íŠ¸ì˜ ì›ì†Œë¥¼ ìˆ˜ì •í•˜ë ¤ê³  í•˜ë©´ `UnsupportedOperationException` ì´ ë°œìƒí•˜ê³ ,

í•´ë‹¹ ì˜ˆì™¸ëŠ” runtime ì—, í•´ë‹¹ line ì´ ìˆ˜í–‰ë  ë•Œì—ë§Œ ë°œìƒí•˜ë¯€ë¡œ ì°¾ê¸° ì–´ë µì£ .

`UnsupportedOperationException` ì´ triggering ë˜ëŠ” ì½”ë“œëŠ” `UnmodifiableList` ë‚´ë¶€ ì½”ë“œë¥¼ í™•ì¸í•´ì„œ í™•ì‹ ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```java

public static <T> List<T> unmodifiableList(List<? extends T> list) {
         // ... ìƒëµ ...
    }

    /**
     * @serial include
     */
    static class UnmodifiableList<E> extends UnmodifiableCollection<E>
                                  implements List<E> {
        // ... ìƒëµ ...
        public E set(int index, E element) {
            throw new UnsupportedOperationException();
        }
        public void add(int index, E element) {
            throw new UnsupportedOperationException();
        }
        public E remove(int index) {
            throw new UnsupportedOperationException();
        }
        public boolean addAll(int index, Collection<? extends E> c) {
            throw new UnsupportedOperationException();
        }

        @Override
        public void replaceAll(UnaryOperator<E> operator) {
            throw new UnsupportedOperationException();
        }
        @Override
        public void sort(Comparator<? super E> c) {
            throw new UnsupportedOperationException();
        }

        // ... ìƒëµ ...

        public ListIterator<E> listIterator(final int index) {
            return new ListIterator<E>() {
                
                // ... ìƒëµ ...

                public void remove() {
                    throw new UnsupportedOperationException();
                }
                public void set(E e) {
                    throw new UnsupportedOperationException();
                }
                public void add(E e) {
                    throw new UnsupportedOperationException();
                }
            };
          // ... ìƒëµ ...
        }
```

---

P.S.
```java
í•­ìƒ ì˜ì‹¬í•´...
```


---

## References
- [https://stackoverflow.com/questions/65969919/differences-of-java-16s-stream-tolist-and-stream-collectcollectors-tolist](https://stackoverflow.com/questions/65969919/differences-of-java-16s-stream-tolist-and-stream-collectcollectors-tolist)


